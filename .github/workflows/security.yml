name: Security Scan

on:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main ]
  workflow_dispatch:
  schedule:
    - cron: '0 2 * * 1' # weekly full scan

permissions:
  contents: read

env:
  GOSEC_VERSION: v2.22.10
  FAIL_ON_MEDIUM: "false"

jobs:
  codeql:
    name: CodeQL Analysis (Go)
    runs-on: ubuntu-22.04
    timeout-minutes: 60

    permissions:
      contents: read
      actions: read
      security-events: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v4
        with:
          languages: go
          queries: security-and-quality
          build-mode: autobuild

      - name: Autobuild (Go)
        uses: github/codeql-action/autobuild@v4

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v4

  gosec:
    name: Gosec Security Scan
    runs-on: ubuntu-22.04
    timeout-minutes: 30

    permissions:
      contents: read
      actions: read
      security-events: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true

      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Install gosec
        run: |
          set -euo pipefail
          go install github.com/securego/gosec/v2/cmd/gosec@${GOSEC_VERSION}
          echo "$(go env GOPATH)/bin" >> "$GITHUB_PATH"
          gosec version

      - name: Run gosec
        id: gosec
        run: |
          set -euo pipefail

          WORKDIR="${GITHUB_WORKSPACE}"
          SARIF="${WORKDIR}/gosec.sarif"
          JSON="${WORKDIR}/gosec.json"

          echo "Running gosec security scan..."

          EXIT_CODE=0
          set +e
          gosec -fmt=sarif -out="${SARIF}" -json -out="${JSON}" ./...
          EXIT_CODE=$?
          set -e

          echo ""
          echo "================ Security Findings (Top 20) ================"

          if [ -f "${JSON}" ]; then
            jq -r '
              .Issues[]
              | select(.Severity == "HIGH" or .Severity == "CRITICAL")
              | "❌ [\(.Severity)] \(.RuleID)
                 File: \(.File):\(.Line)
                 What: \(.Details)
                 Why:  \(.Confidence)"
            ' "${JSON}" | head -n 20
          else
            echo "No gosec.json generated"
          fi

          HIGH=$(jq '[.Issues[] | select(.Severity=="HIGH" or .Severity=="CRITICAL")] | length' "${JSON}" 2>/dev/null || echo 0)
          MED=$(jq '[.Issues[] | select(.Severity=="MEDIUM")] | length' "${JSON}" 2>/dev/null || echo 0)

          echo ""
          echo "================ Summary ================="
          echo "HIGH/CRITICAL: ${HIGH}"
          echo "MEDIUM:        ${MED}"
          echo "================================================"

          echo "high=${HIGH}" >> "$GITHUB_OUTPUT"
          echo "medium=${MED}" >> "$GITHUB_OUTPUT"
          echo "exit_code=${EXIT_CODE}" >> "$GITHUB_OUTPUT"
          echo "sarif=${SARIF}" >> "$GITHUB_OUTPUT"

      - name: Upload SARIF to GitHub Security
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: ${{ steps.gosec.outputs.sarif }}
          category: gosec

      - name: Upload gosec artifacts
        uses: actions/upload-artifact@v4
        with:
          name: gosec-${{ github.run_id }}
          path: |
            ${{ github.workspace }}/gosec.sarif
            ${{ github.workspace }}/gosec.log
          retention-days: 7

      - name: Enforce security policy
        run: |
          HIGH="${{ steps.gosec.outputs.high }}"
          MED="${{ steps.gosec.outputs.medium }}"
          FAIL_MED="${{ env.FAIL_ON_MEDIUM }}"

          echo "HIGH=${HIGH}, MEDIUM=${MED}, FAIL_ON_MEDIUM=${FAIL_MED}"

          if [ "${HIGH}" -gt 0 ]; then
            echo "❌ HIGH severity vulnerabilities detected"
            exit 1
          fi

          if [ "${FAIL_MED}" = "true" ] && [ "${MED}" -gt 0 ]; then
            echo "❌ MEDIUM severity vulnerabilities detected"
            exit 1
          fi

          echo "✅ gosec policy passed"
