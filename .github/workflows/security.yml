name: Security Scan

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  actions: read

defaults:
  run:
    shell: bash

jobs:
  codeql:
    name: CodeQL Analysis (Go)
    runs-on: ubuntu-22.04
    timeout-minutes: 60

    permissions:
      contents: read
      security-events: write
      actions: read

    strategy:
      fail-fast: false
      matrix:
        language: [ go ]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4.2.2
        with:
          fetch-depth: 0

      - name: Detect go.mod
        id: find-mod
        run: |
          MODPATH=$(git ls-files --full-name -- **/go.mod | head -n 1 || true)
          if [ -z "$MODPATH" ]; then
            echo "no_go_mod=true" >> $GITHUB_OUTPUT
            echo "module_dir=." >> $GITHUB_OUTPUT
          else
            echo "no_go_mod=false" >> $GITHUB_OUTPUT
            echo "module_dir=$(dirname "$MODPATH")" >> $GITHUB_OUTPUT
          fi

      - name: Skip CodeQL if no Go module
        if: ${{ steps.find-mod.outputs.no_go_mod == 'true' }}
        run: echo "No go.mod detected, skipping CodeQL."

      - name: Setup Go
        if: ${{ steps.find-mod.outputs.no_go_mod != 'true' }}
        uses: actions/setup-go@v5.2.0
        with:
          go-version-file: ${{ steps.find-mod.outputs.module_dir }}/go.mod
          cache: true
          cache-dependency-path: ${{ steps.find-mod.outputs.module_dir }}/go.sum

      - name: Cache Go build
        if: ${{ steps.find-mod.outputs.no_go_mod != 'true' }}
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}

      - name: Initialize CodeQL
        if: ${{ steps.find-mod.outputs.no_go_mod != 'true' }}
        uses: github/codeql-action/init@v3.28.0
        with:
          languages: go
          queries: security-and-quality
          build-mode: auto

      - name: CodeQL autobuild (best effort)
        if: ${{ steps.find-mod.outputs.no_go_mod != 'true' }}
        id: autobuild
        uses: github/codeql-action/autobuild@v3.28.0
        continue-on-error: true

      - name: Manual Go build fallback
        if: ${{ steps.find-mod.outputs.no_go_mod != 'true' && steps.autobuild.outcome != 'success' }}
        run: |
          set -euo pipefail
          cd "${{ steps.find-mod.outputs.module_dir }}"
          go mod download
          go build ./...

      - name: Analyze with CodeQL
        if: ${{ steps.find-mod.outputs.no_go_mod != 'true' }}
        uses: github/codeql-action/analyze@v3.28.0
        with:
          fail-fast: false

  gosec:
    name: Gosec Analysis
    runs-on: ubuntu-22.04
    timeout-minutes: 30

    permissions:
      contents: read
      security-events: write
      actions: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4.2.2

      - name: Detect go.mod
        id: find-mod
        run: |
          MODPATH=$(git ls-files --full-name -- **/go.mod | head -n 1 || true)
          if [ -z "$MODPATH" ]; then
            echo "no_go_mod=true" >> $GITHUB_OUTPUT
            echo "module_dir=." >> $GITHUB_OUTPUT
          else
            echo "no_go_mod=false" >> $GITHUB_OUTPUT
            echo "module_dir=$(dirname "$MODPATH")" >> $GITHUB_OUTPUT
          fi

      - name: Skip gosec if no Go module
        if: ${{ steps.find-mod.outputs.no_go_mod == 'true' }}
        run: echo "No go.mod detected, skipping gosec."

      - name: Setup Go
        if: ${{ steps.find-mod.outputs.no_go_mod != 'true' }}
        uses: actions/setup-go@v5.2.0
        with:
          go-version-file: ${{ steps.find-mod.outputs.module_dir }}/go.mod
          cache: true

      - name: Install gosec
        if: ${{ steps.find-mod.outputs.no_go_mod != 'true' }}
        run: |
          set -euo pipefail
          go install github.com/securego/gosec/v2/cmd/gosec@v2.22.10
          echo "$(go env GOPATH)/bin" >> $GITHUB_PATH
          gosec version

      - name: Run gosec
        if: ${{ steps.find-mod.outputs.no_go_mod != 'true' }}
        id: gosec
        run: |
          set -euo pipefail
          MODULE_DIR="${{ steps.find-mod.outputs.module_dir }}"
          if [[ "$MODULE_DIR" == "." ]]; then
            SARIF="${GITHUB_WORKSPACE}/gosec.sarif"
          else
            SARIF="${GITHUB_WORKSPACE}/${MODULE_DIR}/gosec.sarif"
          fi

          cd "$MODULE_DIR"
          EXIT=0
          gosec -fmt=sarif -out="$SARIF" ./... || EXIT=$?
          echo "exit_code=$EXIT" >> $GITHUB_OUTPUT
          echo "sarif=$SARIF" >> $GITHUB_OUTPUT

      - name: Upload SARIF to Code Scanning
        if: ${{ steps.gosec.outputs.exit_code != '0' }}
        uses: github/codeql-action/upload-sarif@v3.28.0
        with:
          sarif_file: ${{ steps.gosec.outputs.sarif }}

      - name: Upload SARIF artifact
        if: ${{ steps.find-mod.outputs.no_go_mod != 'true' }}
        uses: actions/upload-artifact@v4.5.0
        with:
          name: gosec-sarif
          path: ${{ steps.gosec.outputs.sarif }}
          retention-days: 7

      - name: Fail on gosec findings
        if: ${{ steps.gosec.outputs.exit_code != '0' }}
        run: exit 1
