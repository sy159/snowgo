name: Security Scan

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  security-events: write
  actions: read

jobs:
  # CodeQL - 官方 SAST
  codeql:
    name: CodeQL Analysis
    runs-on: ubuntu-22.04

    strategy:
      fail-fast: false
      matrix:
        language: [ go ]

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true
          cache-dependency-path: go.sum

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v4
        with:
          languages: ${{ matrix.language }}
          queries: security-extended,security-and-quality
          build-mode: manual

      - name: Build
        run: go build ./...

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v4

  # Gosec - Go 专用安全扫描（SARIF + console）
  gosec:
    name: Gosec Analysis
    runs-on: ubuntu-22.04
    timeout-minutes: 20

    permissions:
      contents: read
      security-events: write

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true
          cache-dependency-path: go.sum

      - name: Install Gosec (pinned)
        run: |
          GOSEC_VERSION=v2.22.10
          go install github.com/securego/gosec/v2/cmd/gosec@${GOSEC_VERSION}
          echo "$(go env GOPATH)/bin" >> $GITHUB_PATH
          gosec version

      - name: Run Gosec (console + SARIF)
        run: |
          gosec -fmt=sarif -out=gosec.sarif -stdout -quiet \
                -exclude-generated -exclude=G115,G404 ./...

      - name: Upload Gosec SARIF
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: gosec.sarif
          category: gosec
