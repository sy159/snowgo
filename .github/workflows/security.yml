name: Security Scan

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
  schedule:
    - cron: '0 10 * * 5' # 每周五18:00, 配置的是utc时间

permissions:
  contents: read

env:
  GOSEC_VERSION: v2.22.10
  FAIL_ON_MEDIUM: "false"

jobs:
  codeql:
    name: CodeQL Analysis (Go)
    runs-on: ubuntu-22.04
    timeout-minutes: 60

    permissions:
      contents: read
      security-events: write

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true

      - uses: github/codeql-action/init@v4
        with:
          languages: go
          queries: security-and-quality
          build-mode: autobuild

      - uses: github/codeql-action/autobuild@v4

      - uses: github/codeql-action/analyze@v4

  gosec:
    name: Gosec Security Scan
    runs-on: ubuntu-22.04
    timeout-minutes: 30

    permissions:
      contents: read

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true

      - name: Install tools
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Install gosec
        run: |
          go install github.com/securego/gosec/v2/cmd/gosec@${GOSEC_VERSION}
          echo "$(go env GOPATH)/bin" >> "$GITHUB_PATH"
          gosec version

      - name: Run gosec and print findings
        id: gosec
        run: |
          set -euo pipefail

          SARIF="${GITHUB_WORKSPACE}/gosec.sarif"
          LOG="${GITHUB_WORKSPACE}/gosec.log"

          echo "▶ Running gosec..."
          set +e
          gosec -fmt=sarif -out="${SARIF}" ./...
          set -e

          if [ ! -f "${SARIF}" ]; then
            echo "❌ gosec failed to generate SARIF"
            exit 1
          fi

          echo "" | tee "${LOG}"
          echo "================ gosec findings ================" | tee -a "${LOG}"

          jq -r '
            .runs[0].results[]
            | {
                severity: (.level // .properties.severity // "UNKNOWN"),
                rule: (.ruleId // "UNKNOWN"),
                file: (.locations[0].physicalLocation.artifactLocation.uri // "unknown"),
                line: (.locations[0].physicalLocation.region.startLine // 0),
                message: (.message.text // "")
              }
            | "• [\(.severity)] \(.rule)\n  File: \(.file):\(.line)\n  What: \(.message)\n"
          ' "${SARIF}" | tee -a "${LOG}"

          HIGH=$(jq '[.runs[0].results[] | select((.level // .properties.severity // "") | test("(?i)error|high|critical"))] | length' "${SARIF}")
          MED=$(jq '[.runs[0].results[] | select((.level // .properties.severity // "") | test("(?i)warning|medium"))] | length' "${SARIF}")

          echo "================ Summary ================" | tee -a "${LOG}"
          echo "HIGH   : ${HIGH}" | tee -a "${LOG}"
          echo "MEDIUM : ${MED}" | tee -a "${LOG}"
          echo "========================================" | tee -a "${LOG}"

          echo "high=${HIGH}" >> "$GITHUB_OUTPUT"
          echo "medium=${MED}" >> "$GITHUB_OUTPUT"

      - name: Upload gosec artifacts
        uses: actions/upload-artifact@v4
        with:
          name: gosec-${{ github.run_id }}
          path: |
            ${{ github.workspace }}/gosec.sarif
            ${{ github.workspace }}/gosec.log
          retention-days: 7

      - name: Enforce policy (only after details are printed)
        run: |
          HIGH="${{ steps.gosec.outputs.high }}"
          MEDIUM="${{ steps.gosec.outputs.medium }}"
          FAIL_MED="${{ env.FAIL_ON_MEDIUM }}"

          echo "Policy check: HIGH=${HIGH}, MEDIUM=${MEDIUM}, FAIL_ON_MEDIUM=${FAIL_MED}"

          if [ "${HIGH}" -gt 0 ]; then
            echo "❌ HIGH severity issues detected"
            exit 1
          fi

          if [ "${FAIL_MED}" = "true" ] && [ "${MEDIUM}" -gt 0 ]; then
            echo "❌ MEDIUM severity issues detected"
            exit 1
          fi

          echo "✅ gosec passed"
