name: Security Scan

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
  schedule:
    - cron: '0 10 * * 5' # 每周五 UTC 10:00 -> 北京时间周五 18:00

permissions:
  contents: read
  security-events: write

env:
  GOSEC_VERSION: v2.22.10
  FAIL_ON_MEDIUM: "false"

jobs:
  codeql:
    name: CodeQL Analysis (Go)
    runs-on: ubuntu-22.04
    timeout-minutes: 60
    permissions:
      contents: read
      actions: read
      security-events: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true
          cache-dependency-path: go.sum

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v4
        with:
          languages: go
          queries: security-and-quality
          build-mode: autobuild

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v4
        with:
          upload: true
          wait-for-processing: true

  gosec:
    name: Gosec Security Scan
    runs-on: ubuntu-22.04
    timeout-minutes: 30
    permissions:
      contents: read
      actions: read
      security-events: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true
          cache-dependency-path: go.sum

      - uses: actions/cache@v4
        with:
          path: |
            ~/go/pkg/mod
            ~/.cache/go-build
          key: go-mod-${{ runner.os }}-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            go-mod-${{ runner.os }}-

      - name: Install utilities
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Install gosec
        run: |
          set -euo pipefail
          go install github.com/securego/gosec/v2/cmd/gosec@${GOSEC_VERSION}
          echo "$(go env GOPATH)/bin" >> "$GITHUB_PATH"
          gosec version

      - name: Run gosec scan
        id: gosec-scan
        run: |
          set -euo pipefail
          SARIF="${GITHUB_WORKSPACE}/gosec.sarif"
          LOG="${GITHUB_WORKSPACE}/gosec.log"
          rm -f "${SARIF}" "${LOG}" || true

          echo "Running gosec scan..."
          set +e
          gosec -fmt=sarif -out="${SARIF}" ./... 2>&1 | tee "${LOG}"
          GC_EXIT=$?
          set -e

          echo "exit_code=${GC_EXIT}" >> "$GITHUB_OUTPUT"
          echo "sarif=${SARIF}" >> "$GITHUB_OUTPUT"

          SARIF_HAS_RUNS="false"
          if [ -f "${SARIF}" ] && [ -s "${SARIF}" ]; then
            if jq -e 'has("runs") and (.runs | length) > 0' "${SARIF}" >/dev/null 2>&1; then
              SARIF_HAS_RUNS="true"
            fi
          fi
          echo "sarif_has_runs=${SARIF_HAS_RUNS}" >> "$GITHUB_OUTPUT"

          HIGH=$(jq -r 'if (has("runs") and (.runs|length)>0) then ([.runs[]?.results[]? | select(((.level // (.properties.severity // "")) | test("(?i)high|critical")))] | length) else 0 end' "${SARIF}" 2>/dev/null || echo "0")
          MED=$(jq -r 'if (has("runs") and (.runs|length)>0) then ([.runs[]?.results[]? | select(((.level // (.properties.severity // "")) | test("(?i)medium")))] | length) else 0 end' "${SARIF}" 2>/dev/null || echo "0")
          echo "high=${HIGH}" >> "$GITHUB_OUTPUT"
          echo "medium=${MED}" >> "$GITHUB_OUTPUT"

      - name: Upload SARIF
        if: steps.gosec-scan.outputs.sarif_has_runs == 'true'
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: ${{ steps.gosec-scan.outputs.sarif }}
          category: gosec

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: gosec-${{ github.run_id }}
          path: |
            ${{ github.workspace }}/gosec.log
            ${{ github.workspace }}/gosec.sarif
          retention-days: 7
          if-no-files-found: warn

      - name: Enforce security policy
        run: |
          set -euo pipefail
          HIGH="${{ steps.gosec-scan.outputs.high }}"
          MED="${{ steps.gosec-scan.outputs.medium }}"
          GC_EXIT="${{ steps.gosec-scan.outputs.exit_code }}"
          GC_EXIT=${GC_EXIT:-0}
          SARIF_HAS_RUNS="${{ steps.gosec-scan.outputs.sarif_has_runs }}"
          FAIL_MED="${{ env.FAIL_ON_MEDIUM }}"

          is_true() { case "$1" in "true"|"True"|"TRUE"|"1") return 0 ;; *) return 1 ;; esac; }

          if [ "${GC_EXIT}" -ge 2 ]; then
            echo "::error::gosec execution failed with exit code ${GC_EXIT}. See gosec.log"
            exit 1
          fi

          if [ "${HIGH}" -gt 0 ]; then
            echo "::error::High/Critical severity vulnerabilities detected (count=${HIGH})"
            exit 1
          fi

          if is_true "${FAIL_MED}" && [ "${MED}" -gt 0 ]; then
            echo "::error::Medium severity vulnerabilities detected (count=${MED})"
            exit 1
          fi

          if [ "${SARIF_HAS_RUNS}" != "true" ] && [ "${GC_EXIT}" -eq 1 ]; then
            echo "::warning::gosec reported issues (exit_code=1) but SARIF contained no runs. See gosec.log"
          fi

          echo "✅ gosec policy passed"
